<!DOCTYPE html>
<html class="h-full">
  <head>
    <title><%= content_for(:title) || "Clear" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Clear">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= yield :head %>
    <%= favicon_link_tag "logo-favicon.png", rel: "icon", type: "image/png" %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>
  </head>
  <body data-theme="green" class="h-full overflow-hidden bg-zinc-950 text-zinc-100">
    <div data-controller="sidebar drawer" class="flex h-full min-h-0 overflow-hidden">
      <aside
        data-sidebar-target="sidebar"
        data-collapsed="false"
        class="group/sidebar flex h-full flex-col overflow-hidden
               w-64 data-[collapsed=true]:w-16 transition-[width] duration-200
               border-r border-emerald-900/30 bg-[#15261d]"
      >
        <div class="shrink-0 flex items-center gap-3 px-3 py-3">
          <button
            type="button"
            data-action="sidebar#toggle"
            class="inline-flex h-10 w-10 items-center justify-center rounded-xl
                  border border-white/10 bg-zinc-950/30 hover:bg-white/5 transition
                 text-zinc-200 hover:text-zinc-50
                  [&_svg]:text-current
                  [&_svg_*]:stroke-current
                  [&_svg_*]:fill-none"
            aria-label="Toggle navigation"
          >
            <span class="[&>svg]:h-6 [&>svg]:w-6">
              <%= icon "menu-01-stroke-rounded" %>
            </span>
          </button>
          <div class="min-w-0 group-data-[collapsed=true]/sidebar:hidden">
            <div class="text-base font-semibold tracking-tight text-zinc-100 truncate">Clear</div>
            <div class="text-sm text-zinc-300/80 truncate">Navigation</div>
          </div>
        </div>
        <!-- Sidebar content -->
        <div class="flex-1 min-h-0 overflow-y-auto">
          <%= render Studs::LeftNavComponent.new(
            brand: nil,
            items: (
              [
                { label: "Dashboard", path: "/dashboard",  icon_name: "dashboard-circle-stroke-rounded" },
                { label: "Agenda",    path: "/agenda",     icon_name: "view-agenda-stroke-rounded" },
                { label: "Courses",   path: "/courses",    icon_name: "course-stroke-rounded" },
                { label: "Events",    path: "/events",     icon_name: "timeline-event-stroke-rounded" },
                { label: "Schedule",  path: "/schedule",   icon_name: "calendar-02-stroke-rounded" },
                { label: "Syllabus",  path: "/syllabuses", icon_name: "file-01-stroke-rounded" }
              ] +
              (current_user&.admin? ? [
                { label: "Users", path: "/admin/users", icon_name: "user-02-stroke-rounded" },
                { label: "UI",    path: "/ui",          icon_name: "search-01-stroke-rounded" }
              ] : [])
            ),
            class_name: "h-full"
          ) %>
        </div>
      </aside>
      <!-- RIGHT COLUMN (top bar + page content) -->
      <div class="flex min-w-0 flex-1 flex-col overflow-hidden">
        <!-- Top bar -->
        <header class="shrink-0">
          <%= render Studs::TopBarComponent.new(
                title: (content_for?(:page_title) ? yield(:page_title) : "Dashboard"),
                subtitle: (content_for?(:page_subtitle) ? yield(:page_subtitle) : nil)
              ) do |t| %>
          <% end %>
        </header>
        <!-- Page content -->
        <main class="min-w-0 min-h-0 flex-1 overflow-y-auto scrollbars">
          <div class="px-6 py-6">
            <% if notice.present? %>
              <div class="mb-4 rounded-2xl border border-emerald-900 bg-emerald-950/40 px-4 py-3 text-sm text-emerald-200">
                <%= notice %>
              </div>
            <% end %>
            <% if alert.present? %>
              <div class="mb-4 rounded-2xl border border-rose-900 bg-rose-950/40 px-4 py-3 text-sm text-rose-200">
                <%= alert %>
              </div>
            <% end %>
            <%= yield %>
          </div>
        </main>
      </div>
      <div id="drawer_events" class="hidden"></div>
      <!-- Event Drawer Overlay -->
      <div
        data-drawer-target="overlay"
        data-action="click->drawer#close"
        class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
      </div>
      <!-- Event Drawer Panel -->
      <div class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none px-4">
        <div
          data-drawer-target="panel"
          role="dialog"
          aria-modal="true"
          class="pointer-events-auto w-[min(92vw,64rem)]
                max-h-[85vh] overflow-hidden
                rounded-2xl border border-zinc-800 bg-zinc-950/90 backdrop-blur shadow-2xl
                translate-x-[110vw] transition-transform duration-300 ease-in-out">
          <%= turbo_frame_tag "event_drawer",
                class: "block h-full",
                data: {
                  drawer_target: "frame",
                  action: "turbo:before-fetch-request->drawer#showSkeleton turbo:frame-load->drawer#frameLoaded turbo:submit-end->drawer#submitEnded"
                } do %>
          <% end %>
        </div>
      </div>
      <!-- Event Drawer Skeleton -->
      <template data-drawer-target="skeleton">
        <%= render "events/drawer_skeleton" %>
      </template>
    </div>
    <script>
      function bindPasswordToggles() {
        document.querySelectorAll('[data-password-toggle]').forEach((button) => {
          if (button.dataset.bound === "true") return; // prevent double binding
          button.dataset.bound = "true";

          button.addEventListener("click", () => {
            const input = document.getElementById(button.dataset.target);
            const showIcon = button.querySelector("[data-show]");
            const hideIcon = button.querySelector("[data-hide]");

            const isHidden = input.type === "password";
            input.type = isHidden ? "text" : "password";

            showIcon.classList.toggle("hidden", isHidden);
            hideIcon.classList.toggle("hidden", !isHidden);
          });
        });
      }

      document.addEventListener("turbo:load", bindPasswordToggles);
      document.addEventListener("turbo:frame-load", bindPasswordToggles);
    </script>
  </body>
</html>
