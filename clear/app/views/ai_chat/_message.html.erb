<style>
  @keyframes aiChatPopIn {
    from {
      opacity: 0;
      transform: translateY(6px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .ai-chat-pop {
    animation: aiChatPopIn 180ms ease-out both;
  }
</style>

<% is_user = (m["role"].to_s.downcase == "user") %>

<div class="flex <%= is_user ? "justify-end" : "justify-start" %> ai-chat-pop">
  <div
    class="<%=
      [
        "max-w-[85%] rounded-2xl px-4 py-3 text-sm leading-relaxed border",
        (is_user ?
          "bg-green-600/15 border-green-500/30 text-emerald-100 shadow-[0_0_20px_rgba(34,197,94,0.08)]" :
          "bg-zinc-900/50 border-zinc-800 text-zinc-100")
      ].join(" ")
    %>"
  >
    <div class="mb-1 flex items-center justify-between gap-3">
      <span class="<%= is_user ? "text-emerald-200" : "text-zinc-300" %> text-xs font-semibold uppercase tracking-wide">
        <%= m["role"] %>
      </span>
    </div>

    <% if is_user %>
        <div class="prose prose-invert prose-sm max-w-none whitespace-normal">
        <%= simple_format(h(m["content"].to_s)) %>
        </div>
    <% else %>
      <% raw_text = m["content"].to_s %>
      <% safe_attr = ERB::Util.html_escape(raw_text).gsub("\n", "&#10;") %>

      <div
        data-controller="typewriter"
        data-typewriter-text-value="<%= safe_attr %>"
        class="prose prose-invert prose-sm max-w-none whitespace-pre-wrap"
      >
        <%= simple_format(h(raw_text)) %>
      </div>
    <% end %>
  </div>
</div>

